<!DOCTYPE HTML>

<html>
  <div class="column">
	  <head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta name="author" content="Benjamin Vickers" />
		<link rel="stylesheet" type="text/css" href="/blog/assets/css/normalize.css" /> 
		<link rel="stylesheet" type="text/css" href="/blog/assets/css/standard.css" /> 
		<link rel="stylesheet" type="text/css" href='/blog/assets/css/nv.d3.css' /> 
		<script src='/blog/assets/javascripts/d3.v3.js'></script>
		<script src='/blog/assets/javascripts/nv.d3.js'></script>
		<script src='/blog/assets/javascripts/prettify.js'></script>
		<script src='/blog/assets/javascripts/stream_layers.js'></script>
		<title>technology</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

		<!-- mathJAX -->
		<script type="text/javascript" 
		src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
		</script>
		<!-- google analytics -->
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		  ga('create', 'UA-55111700-1', 'auto');
		  ga('send', 'pageview');

		</script>		
	  </head>
	  <body>
		<header>
			<div class="menu">
				BENJVI
				 - <a href="/blog/">POSTS</a>
				
					- <a href="/blog/Categories/thoughts.html">thoughts</a> 
				
					- <a href="/blog/Categories/science.html">science</a> 
				
					- <a href="/blog/Categories/arts.html">arts</a> 
				
					- <a href="/blog/Categories/technology.html">technology</a> 
				
				 - <a href="/blog/profile.html">PROFILE</a>
				
			</div>
			<div class="bannerholder">
			<img src="/blog/img/ibelonghere.png" class="banner"/>
			</div>
			<div class="overlay">
				<div class="overlaytext"></div>
				<h1>technology</h1>
			</div>
		</header>
		<section>
		  <div class="content">
  <div class="related">
      
		   <div class="postpreview">
			<div class="postcontent">
				<div class="date">May 19, 2015</div>
				<h2><a href="/blog//2015/05/19/Infrastructure-As-Code-Is-Not-Configuration-Management">Infrastructure as Code is not Configuration Management</a></h2>
				<p><p>For the past few months, I have been concerned with deploying complex applications from the ground up on top of my company's IaaS platform, Interoute VDC. Wanting not to re-invent the wheel , we have spent quite some time looking at tools that could do the job. In this search I somewhere came across the sentiment that forms the title of this piece, and for some time, I was quite confused about this [1]. And it seems like lots of others are confused too. There are a plethora of plugins adding cloud provisioning capabilities to traditional Configuration Management tools such as Puppet, Chef, or Ansible. But, we eventually settled on a different solution for our provisioning: a new framework called Terraform. This is designed with IaaS specific problems in mind, which leads to some big wins, as we will see. There are three main points of differentiation:</p>

<!--more-->


<p></p>

<h3>1. Advanced Graph Abstraction</h3>

<p>The infrastructure provisioning process is quite a complex one: many different kinds of resources need to be created, and very often one resource must be instantiated before another can start to be built. It is desirable that the resource provisionings that don't depend on each other are performed in parallel, as some provisioning actions can take quite a long time. This sequence of dependency relations can be naturally described as a directed acyclic graph. Let's see the graphs for a couple of example infrastructure configurations:</p>

<p><img src="/blog/img/lync-graph.png" style="min-height:230px"/>
<img src="/blog/img/cluster-coreos.png" style="max-height:230px"/></p>

<p>These correspond to a Lync installation and a CoreOS cluster, respectively. For the Lync installation (for example), this diagram tells us that the Lync Windows template must be present before the VMs (instances) can be created, as must the networks be present before the VMs are added to them. One VM has an additional volume, so the VM must be ready before that volume can be attached.</p>

<p>Having had the experience of developing one of these with custom code (and no framework), I must say that ensuring that the order of component deployment was not trivial and took up a significant amount of thinking time and development time. Therefore, this is a great place to apply Inversion of Control to replace these ideosyncratic problems with a general solution. to that end, Terraform includes a graph-building algorithm that will build resource provisioning order for you at run-time, given only a description of the resources you want to create. The graph abstraction is not unique to Terraform, but it has the most advanced system I have seen. E.g. to create a template, network and VM from our lync environment, we would need the following <em>configuration</em>:</p>

<pre><code>
resource "cloudstack_template" "z1-lync-win-tmpl" {
    name = "ubuntu image"
    url = "https://mywebsite.com/myimage.ova"
    os_type = "Windows"
    hypervisor = "VMware"
    format = "OVA"://
    zone = "Slough (ESX)"
}

resource "cloudstack_network" "z1-lync-ipvpn-DUMMY" {
    name = "SL-ipvpn-lync-DUMMY"
    cidr = "192.168.49.0/26"
    network_offering = "PrivateWithGatewayServices"
    zone = "Slough (ESX)"
}

resource "cloudstack_instance" "z1-lync-fe" {
    name = "SL-LFE101-MSLYNC-HFE-ua"
    service_offering = "32768-8"
    network = ["${cloudstack_network.z1-lync-ipvpn-DUMMY.name}"]
    template = "${cloudstack_template.z1-lync-win-tmpl.name}"
    zone = "Slough (ESX)"
}
</code></pre>


<p>As we see here, to indicate dependencies between two resources, we can simply reference one property of resource no. 1 that will be used to construct resource no. 2. For example, our desired VM configuration in this configuration refers to both the network and the template. It doesn't actually matter whether the property value was something we knew ahead of time (as above) or whether the property is calculated while provisioning the resource. This is a great feature and I'm not aware of any other configuration management tool that can do anything like this so easily. In Ansible, it seems fairly easy to reference variables we've defined - as tasks run in a shared context, but we get no help in ordering resources as there is no graph abstraction. In Puppet, there is a graph abstraction so we can specify ordering declaratively, but its not so easy to refer to variables. I have not used Chef or Salt, but I believe these fall somewhere between the approach of Ansible and Puppet.</p>

<p>Configuration management tools like Puppet and Ansible are aimed at a different problem domain in which the graph abstraction is less important. People seem to think about software installing and configuration as a purely sequential process, and therefore Puppet's graph-based ordering is often described in negative terms - as confusing and over-complicated. The time taken for operations is to be completed is usually quite short, so it is more acceptable to trade away performance in the provisioning strategy for a simpler model.</p>

<p>By contrast, infrastructure provisioning can be a lengthy process, and so Terraform must apply all the actions it can in parallel (given the constraints of the graph). Given the graph can be generated from a set of resource configuration, we must still make sure to use this graph at runtime to determine the ordering of actions. This is where the <em>Communicating Sequential Processes</em> of Go come in. This approach to concurrency is powerful enough to capture the graph abstraction, and therefore when a graph of resources is provisioned by Terraform, it acts as though it is stepping through the leaves of the graph in parallel. The result is a powerful and efficient approach to concurrently provisioning resources.</p>

<h3>2. Being Node-less</h3>

<p>Configuration management tools are designed to ensure the correct configuration exists on a set of pre-existing computers that are under your management. Each computer is treated as a node, which has a particular target configuration. The CM tool performs actions on each node to ensure that its state converges to the desired configuration.</p>

<p>For infrastructure provisioning this seems like nonsense, because it is completely foreign to our use-case. Our resource graph might well contain 'nodes' (VMs) but equally it might not. Nodes don't have a first-class status - indeed our configuration usually only needs to be applied once [2]. While we can work around this with the agent-less Ansible and even with Puppet or Chef, we don't actually need this construct at all. Nevermind all the extra concepts that these systems have for managing and classifying those nodes(classes, roles, etc.). Indeed Terraform, as a specialised and focussed tool, doesn't have any of this and so we won't get distracted by this baggage. [3]</p>

<h3>3. Safe Convergence</h3>

<p>A CM system (rightly) assumes that it can do anything it likes on nodes that it owns. Once a node is added into a configuration manager, it 'manages' the system without regard to the initial state. It simply performs some checks and performs the according actions to converge the state.</p>

<p>In the infrastructure domain, we do not have the same freedom. In this world, we cannot say that everything in my Cloudstack account is 'managed' by Terraform. Instead it is only particular resources within the account that are managed. Therefore, if I create a new Terraform configuration that conflicts with the existing state - for example, I might create a VM that is identically named and in the same network - Terraform will refuse to update the existing VM. According to the convergence model of the Configuration Managers, we expect the VM to be updated to match the new configuration applied. But, as this updating could be destructive, this approach would not be ideal. Instead, we need a more nuanced approach - non-existant resources can be updated, managed resources can be updated or destroyed, but non-managed resources should not be updated or destroyed. Returning to our prexisting VM - we do not know why that VM was already there, and we must ensure that it does not contain any valuable assets before we can manage it with our new Terraform configuration [4].</p>

<p>The other much-touted feature of Terraform is its plan system. Based on the current state of the provisioned infrastructure, it can calculate the actions it will need to perform in order to reach the desired configuration. This is much like the no-op modes of Puppet and Salt. The innovation is that these plans can be used to restrict the provisioning - i.e. only the actions specified by the plan can be performed when it comes time to really apply the configuration. I have not used this too much, so I won't comment on its effectiveness, but this seems like a very useful feature to have in a more mature and/or mission-critical system.</p>

<h3>Conclusion</h3>

<p>We have seen how Terraform, in choosing to focus on the provisioning aspect of Infrastructure as Code, has been able to make some new abstractions and different design choices compared to configuration management tools. These make the system faster, more understandable, and safer. In doing so, it expands a new niche, performing the management functions needed to co-ordinate IaaS for 'a modern datacenter' - expanding the remit of what we are able to do with Infrastructure as Code and acting as a complement to the other tools that are available.</p>

<h3>Notes</h3>

<p>[1] What's more, by most common definitions, Configuration Management <em>is</em> Infrastructure as Code. (i.e. it is a contained-by relation)</p>

<p>[2] This doesn't mean there is no room for mechanisms to allow configuration re-use. Although it still needs some more refinement, Terraform brings modules which provide composability of re-usable porttions of a resource graph.</p>

<p>[3] It is important to note that this idea of a 'node' under management doesn't map well to any concepts in Terraform either. I have spend a lot of time thinking that a particular provider should work like a node. This is not correct - there can be multiple difference infrastructure providers in the same configuration. It is really the entry point into the graph - the base dependency that each resource must have.</p>

<p>[4] Unfortunately, import of resources into Terraform is not currently available. There is a rather inelegant workaround of going to get resource ids and writing them manually into your state file. But the core developers say that an import feature is on the roadmap so hopefully it is coming soon!</p>

<h3>More Info</h3>

<p><a href='https://www.terraform.io/'>Terraform</a></p>

<p><a href='http://www.aosabook.org/en/puppet.html'>Puppet architecture</a></p>

<p><a href='https://news.ycombinator.com/item?id=8098496'>Terraform discussion on HN</a></p>

<p><a href='https://groups.google.com/forum/#!msg/terraform-tool/6Fxnl_bejX4/0O-d17UwhHcJ'>Terraform vs Ansible</a></p>

<p><a href='http://www.infoq.com/news/2015/05/hashimoto-modern-datacenter'>'Automating the Modern Datacenter'</a></p>

<p><a href='http://people.scs.carleton.ca/~soma/biosec/readings/burgess-immunology.pdf'>Theoretical basis of CFEngine - Computer Immunology</a></p>
</p>
			</div>
			<div class="categories">
			Category: 
			
				<a href="/categories/technology.html">technology</a>
			
			</div>
		  </div>
		  <hr>
      
		   <div class="postpreview">
			<div class="postcontent">
				<div class="date">July 21, 2014</div>
				<h2><a href="/blog//2014/07/21/A-Quick-Review-Of-Http-Essentials">A Quick Review Of HTTP Essentials</a></h2>
				<p><h3>Request and Response</h3>


<p>The paradigm conceives of two actors: a client and a server. The client sends a request to the server, of a particular type, and with certain parameters. In reply the server returns a response message. The response message includes a status code in the header - giving information about the requested information, and will also include a body which is the content at the requested URI. Lets look at the process in more detail.</p>

<!--more-->




<h3>The first step: finding the server to connect to (DNS)</h3>


<p>Lets take the normal case (at least it used to be). the user goes to his browser and enters something like: <a href="http://en.wikipedia.org/HTTP">en.wikipedia.org/HTTP</a>. The first step is that the website name needs to be translated into a specific IP address we can address. This process is <em>DNS resolution</em>. It is not necessary to go into all the details here but we do need to know one or two things:</p>

<ol>
    <li>The first time we connect to a website the URL is forwarded first to a DNS server (a recursive name caching server) which would typically be hosted by the ISP. This nameserver forwards the request to the root nameserver, which contains information about the Top Level Domains' nameservers. which then forwards it on the the nameserver responsible for the sub-domain which is given in the website address. This then returns the IP address to the client.</li>
    <li>DNS zones are the areas that are managed - a zone is a continguous area of the namespace that has a nameserver responsible for it. Technically, a zone is comprised of DNS resource entries . There are different types of entries in each zone:
        <ul>
            <li>SOA - the start of authority which holds key zone parameters</li>
            <li>A - the IPv4 address of a host</li>
            <li>AAAA - the IPv6 address of a host</li>
            <li>CNAME - the canonical name of an alias</li>
            <li>MX - mail exchanger for the domain</li>
            <li>NS - the name server for the domain or delegated subdomain</li>
        </ul>
    <li>Local nameserver - the client needs to know which server to connects to in order to access the DNS resolution service (although it may be self-hosted, it rarely is). This piece of information is typically configured by DHCP</li>
</ol>




<h3>Setting up the connection</h3>


<p>Before any requests or responses can be made, a TCP connection needs to be set up. TCP is the lower level on the network stack - which handles data transfer across the networks by splitting the data up into packets and ameliorating problems such as packet loss or duplication.</p>

<h3>Making the request</h3>


<p>Now we have the connection to the target server via TCP. So, we can send our first HTTP request. This request takes the format:</p>

<pre><code>GET /index.html HTTP/1.1
Host: www.mit.edu
User-Agent: HTTPTool/1.0
</code></pre>


<p>There are some important parameters in here. First up is the request method - here it is the GET method, but on other common occasions we will need to use POST. There are more methods, but their use is a little bit rarer (and not supported by HTML standards!). Next, we specify the resource path (note we don't need to specify the full URL as we already have a TCP/IP connection set up to the remote server. Lastly on the first line, we must specify the version of the protocol used.</p>

<p>Here, we also send the name of the host to connect to. This can be useful in situations where multiple hosts are sharing the same IP address. We also send the user-agent, which is used to identify the requestor (eg type of browser) so that the server can send the appropriate type of resource back.</p>

<h3>First Response</h3>


<p>In return, the server will send an HTTP response. This contains the status - whether the content was found or not, or whether it moved, etc. As well, the response will contain the content we requested (if it is indeed there!). This content will usually be the html form containing the main body of the page. A typical HTTP response looks like this:</p>

<pre><code>
HTTP/1.0 200 OK
Date: Fri, 31 Dec 1999 23:59:59 GMT
Content-Type: text/html
Content-Length: 1354

&lt;html&gt;
&lt;body&gt;
&lt;h1&gt;Web Page Title!&lt;/h1&gt;
(more file contents)
  .
  .
  .
&lt;/body&gt;
&lt;/html&gt;
</pre>


<p></code>
Based on this, we need to perform additional GET requests to retrieve the additional resources referenced on the page such as images, javascript, css, and so on.</p>

<p>However, what exactly will be done depends on the HTTP code that is returned. This can be broken down in broad terms:</p>

<ul>
    <li>2XX - Success!</li>
    <li>3XX - Redirection</li>
    <li>4XX - Error on the client side</li>
    <li>5XX - Error on the server side</li>
</ul>


<p>More specifically, we are likely to see and/or use these codes - which are a very small subset of the complete set:</p>

<ul>
<li>200 - Success with resources returned</li>
<li>201 - Resource successfully added (after POSTing a resource)</li>
<li>301 - Permanent  redirect (note for SEO purposes its better to use this than temporary 302 code)</li>
<li>304 - Page hasn't been updated (used for HTTP caching)</li>
<li>401 - Unauthorized. client did not provide the required authentication</li>
<li>404 - page not found (but client will be allowed to request again)</li>
<li>500 - Internal Server Error (generic error code)</li>
<li>503 - Site Unavailable (used to indicate downtime, and the site will be back soon)</li>
 </ul>




<h3>Performance considerations for secondary HTTP request/responses</h3>


<p>There are two main ways we achieve this - by persistance, and by pipelining(parallelism). Persistence is simple, the tcp connection we used is not closed after the first request/response cycle, we keep it open and reuse it for the additional request/responses. This way we save the network round trips that are necessary to set up the connection. Pipelining means that when we have a number of resources we want to fetch, we can send the GET requests in parallel - then the server can start to process them at the same time. Again, we reduce the amount of time we spend waiting for data to travel across the network.</p>

<h3>Why developers need to know about HTTP</h3>


<p>HTTP is the interface that users will use to access the application - it is this that defines the entry points into web application. It determines when data can be sent, in what types, and which methods are available for users. So we talk about three crucial constraints on the system:</p>

<ul>
<li>The URL structure which allows users to reason about the structure of the application (the resources available) [actually this constraint really comes from the definition of URLs]</li>
<li>The range of methods by which the client may query the system, and how they may send parameters that carry state</li>
<li>Which values we can return in response to the client requests and how the client is likely to respond to each</li>
</ul>


<p></p>

<p>It is notable that many web applications have ignored some of those constraints - specifically many sites do not provide URLs for their resources. Their URLs are linked to actions instead to to individual resources or queries. It is also noticeable that these are the most irritating types of sites to use - as they don't make use of the common sets of affordances that users are used to (such as bookmarking, forward/back navigation, etc).</p>

<h3>Representational State Transfer (REST)</h3>


<p>The crucial point here is that the messages sent as part of the HTTP request or response should correspond to the current or intended state, respectively. This builds upon the notion - inherent in the URL - that each address uniquely identifies a particular resource. It is designed to the constraints  of client-server, cached, layered systems. It is designed to  transfer state in a number of controlled types - the data types that we saw in the HTTP requests earlier. These are the "representation" in REST, and the point of this is to maintain encapsulation of the working details of the objects that are held on the server. Also note that REST should be stateless - all the details necessary for a request should be included in the request so that each request is independent from preceding/subsequent requests. Each request should carry a complete representation of state.</p>
</p>
			</div>
			<div class="categories">
			Category: 
			
				<a href="/categories/technology.html">technology</a>
			
			</div>
		  </div>
		  <hr>
      
		   <div class="postpreview">
			<div class="postcontent">
				<div class="date">July  5, 2014</div>
				<h2><a href="/blog//2014/07/05/A-Friendly-FAQ-For-Unit-Testing">A Friendly FAQ For Unit Testing</a></h2>
				<p><h3>The Basics</h3>


<p>Unit testing, in its modern form, is the process of writing automated test scripts that run against your units of code. This is usually tied together with OO programming practices, but also can be applied elsewhere. The benefits are as follows:</p>

<ul>
    <li>Lowers chance of regression in the codebase. This in turn encourages (enables!) refactoring</li>
    <li>Shortens the feedback loop; problems are found earlier</li>
    <li>Is a precise documentation of the system, and the intent of pieces of code</li>
    <li>Encourages good design; it makes you think about the coupling and interfaces of the design</li>
</ul>


<p>The form of the test is usually quite simple - you will have:</p>

<ol>
    <li>A method to set up resources than can be used by all tests</li>
    <li>A method to initialize before every test common dependencies/common state</li>
    <li>The test method itself - which includes:
        <ul>
            <li>Initialization of state and dependencies that are specific to that test method</li>
            <li>Call to the method under test</li>
            <li>Assertions of the expected state that is produced by the test method</li>
        </ul>
    </li>
    <li>Test-specific cleanup</li>
    <li>Cleanup of shared resources after all tests have run</li>
</ol>


<p>Tests will pass when the assertions all return true, and no exceptions are encountered during the test execution. Otherwise, the test will fail.</p>

<!--more-->




<h3>How many tests will I need to write?</h3>




<ul>
    <li>Tests should act as a design document. They should specify all significant conditions that the code under test is expected to deal with and check the correct output is given in each case.</li>
    <li>Typically there will be multiple tests for each public method in a class</li>
    <li>Often people will talk about code coverage. This is merely a convenient heuristic; do not feel compelled to make sure every line of code is covered. Any complex logic which might fail or give unexpected results - or where you could have made a mistake - needs to be tested. That's the principle you must follow.</li>
</ul>




<h3>What exactly is a unit?</h3>


<p>We start from the general, approximate, answer: <em>a unit is an object</em>. An object should be a cohesive unit containing its own behaviours. It is these behaviours we want to test in isolation when we are unit testing. But, there is a complication.</p>

<p>Objects have dependencies. And these dependencies may affect the methods we want to test. And, those objects in turn may have dependencies. We start to get into divisive issues here - but there is a simple question to ask ourselves: how much complexity is hiding behind those objects?</p>

<p>Is there a single model class behind? - in which case we can extend our notion of a unit into a functional one that is composed of the two classes. As shown by design patterns, we are able to identify cohesive units that are larger than a single class. And speaking practically, we should always be able to diagnose a test that fails based on the tests that also fail for the model. Alternatively, is it an input we are receiving through a public interface? Are we trying to access complex resources - a database, or something over the network? These are things that do not belong in the same unit with a normal piece of business logic.</p>

<p>A further principle we need to keep in mind: tests should be largely independent - if one test fails that shouldn't make loads of other tests fail as well. This is what helps us to identify the unit where the problem is and is what helps us debugging.</p>

<h3>What are the common pitfalls?[1]</h3>


<ul>
<li>Don't start by trying to add tests to your existing codebase! It may be possible but the first step should be to add tests to new classes only. You will be able to come back to the existing classes when you have some experience</li>
<li>Avoid testing static methods - unless you are absolutely sure they are functional. Any global state held in static variables leads to unpredictable results in unit tests. Even where static methods are functional, keep a note of them in case the static method might change and become non-functional later. </li>
<li>Avoid testing anything to do with threading or where external resources such as databases, remote servers are involved (later you will find out how to deal with these with mock/fake objects). At the start, just avoid them.</li>
<li> Make sure that you set things up and clear them down properly after each test. Tests can be run in any order so any persistent state between tests - even in external artefacts - will play havoc with your test results</li>
</ul>


<h3>What are mock objects?</h3>


<p>Mock objects - or test objects as we'll call them here [2] - are simulated objects that we can use to stand in for resources we can't access in test, or to for resources which are beyond the scope of our test (ie outside our unit). There are three different categories we might be interested in:</p>

<ol>
<li><em>Stub</em>: These objects return the expected values to the unit that is under test. They might give a single canned response or a number of responses corresponding to parameters passed. They are used to stand in for external dependencies of our test.</li>
<li><em>Fake</em>: This is an object which contains a lightweight implementation of the required functionality. There will actually be some operations/calculations that are actually performed by the object. They largely are used for much the same purpose as stubs, but will be used where it is easier to create some simple logic to make responses, than to manually specify a large number of canned responses.</li>
<li><em>Mock</em>: This is an object that expects to receive a particular number of method calls, with particular parameters. It servers a different purpose than stubs or fakes, it checks that a particular method is called as a result of a test. In other words, these objects are not concerned with providing the correct state for the test case. Rather, they are concerned with behavioural verification. For example, you might check that some logic in a save() method results in a call to a method that writes the result to the database.</li>
</ol>




<h3>Do I need to use stubs or fake objects?</h3>


<p> It is not absolutely vital to use them in your tests immediately. However, once you have got to grips with the basic unit test ideas, it is a good idea to move onto using these quite quickly, as they are necessary to limit the scope of your testing. If your method takes some data from a complicated factory method and then performs some business logic on it, you would probably not want to test the factory method in the unit test for your business logic calculation method. Instead, you should use a stub that directly returns the source data which you want to test on[3].</p>

<h3>Do I need to use mock objects?</h3>


<p>Occasionally. If it feels more comfortable, it is possible to use mock objects instead of stubs. However, it is less often necessary to check the order and the number of method calls and can potentially be an obstacle to re-factoring. For most tests the important point is that the correct state is produced in response to the input conditions. But, where there are concrete (eg externally-facing) interfaces it can be helpful to know that the method calls are made at the right time. There is a lot more to go into here - Martin Fowler writes a more comprehensive (if slightly one-sided) <a href="http://martinfowler.com/articles/mocksArentStubs.html">piece</a>. Bottom line: for a beginner there is more complexity to this approach and limited situations where its absolutely necessary. Don't start off here.</p>

<h3>Which are good testing frameworks to use?</h3>


<p>For basic unit testing frameworks it may be helpful to stick with xUnit - which is a common framework that has been ported to many different languages. With that said, there's not too much difference - I have used the Visual Studio Testing Framework for C#, coming from jUnit, and its not very difficult at all to switch. Most of these frameworks are quite mature and work well so there are not too many problems either way.</p>

<p>With stubbing and mocking frameworks, there is a little bit more variety and a little bit more of a choice to make. From my impressions, Mockito in Java is the cleanest to use, and <a href="http://stackoverflow.com/questions/22697/whats-the-best-mock-framework-for-java">does seem to be the most popular</a>. But, there are many different frameworks with similar features and each with their adherents(this is especially the case for C#), so <a href="http://stackoverflow.com/questions/642620/what-should-i-consider-when-choosing-a-mocking-framework-for-net">there is not always a simple answer</a>. I have been working MoQ with .NET3.5 for some time now and I found that was very easy to use and with enough features, at least for TDD.</p>

<h3>Notes and References</h3>


<ol>
<li>More discussion in <a href="http://www.daedtech.com/introduction-to-unit-testing-part-3-unit-testing-sucks">this article</a></li>
<li>Unfortunately the terminology that is used seems to be a bit inconsistent. For example, "mock" is the most commonly used umbrella term, but it is also a more specific category of object as well. So we use the generic term "test object" for clarity - and use "mock" as a specific type of test object used for behaviour verification</li>
<li>Even this is subject to some debate - as there is some benefits to running mini-integration tests that tests a method along with its dependencies. But, the primary thing we want to know is whether THIS method (the one I'm working on now) works as designed.</li>
<li><a href="http://blog.8thlight.com/uncle-bob/2014/05/10/WhenToMock.html">When to Mock (some straightforward rules)</a></li>
</ol>

</p>
			</div>
			<div class="categories">
			Category: 
			
				<a href="/categories/technology.html">technology</a>
			
			</div>
		  </div>
		  <hr>
      
		   <div class="postpreview">
			<div class="postcontent">
				<div class="date">June  7, 2014</div>
				<h2><a href="/blog//2014/06/07/OCJP6-How-And-Wherefore">Becoming a Certified Java Person</a></h2>
				<p><p>Last weekend, I became an Oracle Certified Java Professional. It took some efforts to prepare for this exam, but in the end I was able to pass with flying colours. So, I thought this would be a good time to share some tips on preparing for the exam - and what you might hope to get from that work beyond a certificate.</p>

<p>First off, I have to say, this is not an easy exam. I do not work with Java every day, but I have been using it sporadically and in my own projects for more than two years. Still, it took me a month of hard (albeit part-time) study including a week of heavy cramming to be really well-versed on all the material. Part of the reason for this is that, as a user of the language, you are not necessarily aware of all the different possibilities; once you find some patterns that work you can just re-use them without knowing about all the other options that the language provides for you.</p>

<!--more-->


<p>There are certainly some pre-requisities: you should have a solid understanding of basic object oriented principles - what are objects, and their variables and methods, what is inheritance, etc. I don't think it would be feasible to pass this exam without having previously seen these concepts and used them in practice. Neither should this exam be the first goal of a newcomer to programming in my opinion - common imperative constructs and flow control need to be second nature to work out what's going on in the code samples that form the questions.</p>

<h3>Tackling the exam</h3>

<p>The exam format is centred around the presentation of many different samples of code, which you typically have to evaluate and predict what will happen when the code is run. These samples are quite short, no more than 40 lines, but the scope of these questions should cover the full set of Java syntax and also the use of core Java APIs (common classes in the java.util and System.io packages, amongst others).</p>

<p>The core information on the exam is covered by the Kathy Bates SCJP6 book. This is a big book - but it covers everything you need to know <em> for Java 6</em>. This is fine for me - I am working in a Java 6 environment and with Android, which is basically a fork of Java 6. But, for later versions of Java, some topics like the use of Exception/File/Calendar would need to be revised. Unfortunately this book was not updated for Java 7, but nevertheless the quality of the exposition in it makes it well worth recommending as a starting point.</p>

<p>Beyond reading the textbook, I found the most useful two activities to be:</p>

<ol>
<li>Taking practice questions (lots of practice questions)</li>
<li>writing out my own notes from the parts of the book that I found difficult - doing further research if things didn't seem clear</li>
</ol>


<p>Writing code is also an important activity, but it will be tricky to find meaningful projects where all the edge cases you will run into on the exam will be applicable. Ideally relevant exercises would be included in your textbook - but the SCJP6 book only has one or two. I therefore found it slightly more productive to focus on the conceptual basis and the reasoning behind the language design.</p>

<h3>Learning Points</h3>

<p>That idea, of having a conceptual basis, also tended to divide the useful topics from the unuseful topics of the exam. For me the most interesting learning points were:</p>

<ul>
<li><em>Getting in-detail with Polymorphism</em>. this is a profoundly useful concept in program design. Perhaps most commonly, this forms a basis for the Dependency Injection pattern, whereby we are able to cast an object to an interface and keep encapsulation whilst still ensuring the necessary dependencies are captured by our object. Similarly it is valuable to be able to realise that instance variables and static methods are still accessible through objects but are not subject to polymorphism.</li>

<li><em>Embracing the expressive power of the language</em>. Java is a large language, and we don't have to use all its concepts to get by. But it is helpful to be aware of the constructs available to express ourselves  most accurately and with fewer side-effects. A good example would be the use of assertions to reason about correct state as we progress through a method. The presence of this as a language feature rather than having to code it up manually indicates that this is an important tool to use when programming, and is a prompt to add it to our toolkit of useful patterns</li>

<li><em>Immutability vs. mutability</em> (reference value assignment vs. object state change). Not strictly a topic on the exam, but from the code presented, we start to see why immutable objects tend to be preferred where possible. Many of the complications in the examples presented come from objects changing in the background (eg if we put an object in a hashmap, and change it, we may not be able to find it again!). This also leads to complicated situations in synchronizing multi-threaded code.</li>

<li><em>Usage of data structures</em>. These are some of the most important basic tools of a programmers trade; it is important not to equate every problem with a nail to be hammered. Not every problem requires a dictionary, or an iterator - this are specific constructs we should use to reflect the needs of a particular design. If that's not enough, most companies want to know that you are able to use these effectively - to know which are appropriate for a particular situation. The exam requires you to know how to make best use of the standard java structures available in the collections framework.</li>
</ul>


<p>
And the least useful:</p>

<ul>
<li>The topics on internationalisation, dates, and formatting didn't seem especially useful to me (especially as most of the Calendar class will be deprecated in Java 8). These topics (a) are not very important to what I'm currently doing, and (b) don't have a strong logic underlying their implementation.</li>

<li>In general, we are expected to go into a little bit too much detail with memorising things like which methods and method arguments are required for each class. Certainly, we sometimes want to know that we must implement (eg) the Sortable interface for sorting objects in our classes, but we can generally rely on an IDE/compiler to point out any mistakes in the method arguments. So long as we know the limitations of those mechanisms, the specific interface details are not always important.</li>
</ul>


<p></p>

<p>In general, I would say that the interesting points are where we can identify language features as enabling good program design, and less interesting is when we have to memorize seemingly arbitrary (or poorly thought-out) choices in language or API design. The main thing I was left wanting was guidance as to correct usage of patterns beyond that enforced by the language. Although we are provided with many code samples, we are left to reason them out on our own. This is the most important next step to build upon this qualification, to synthesize understanding of the language vocabulary with the abstract design patterns theories (like those from GoF/POSA1).</p>

<h3>References</h3>

<ul>
<li><a href="http://www.amazon.co.uk/Certified-Programmer-Study-Guide-CX-310-065/dp/0071591060/ref=sr_1_1?ie=UTF8&qid=1402743264&sr=8-1&keywords=scjp6">SCJP6 book by Kathy Bates</a></li>
<li><a href="http://www.examlab.org/">ExamLab (hard practice exams)</a></li>
<li><a href="http://www.amazon.co.uk/Design-patterns-elements-reusable-object-oriented/dp/0201633612/ref=sr_1_1?ie=UTF8&qid=1402743542&sr=8-1&keywords=gof">"Gang of Four" classic design patterns book</a></li>
<li><a href="http://www.amazon.co.uk/Pattern-Oriented-Software-Architecture-Volume-Patterns/dp/0471958697/ref=sr_1_1?ie=UTF8&qid=1402743604&sr=8-1&keywords=posa1">POSA1 Design Patterns book</a></li>
<li><a href="https://www.coursera.org/course/posa">POSA for Android MOOC</a></li>
</ul>



</p>
			</div>
			<div class="categories">
			Category: 
			
				<a href="/categories/technology.html">technology</a>
			
			</div>
		  </div>
		  <hr>
      
		   <div class="postpreview">
			<div class="postcontent">
				<div class="date">February 28, 2014</div>
				<h2><a href="/blog//2014/02/28/Electric-Dreams-Or-Electric-Relaxation">Electric Dreams or Electric Relaxation?</a></h2>
				<p><p>I've been thinking a little recently about the electric car market. I tend get very excited about the prospect of electric cars taking over our streets (despite the fact that I very rarely need to drive, at the moment). I like the technology, and I like what they stand for. Eco-friendly. Intense acceleration and low centres of mass. This means guilt-free driving pleasure. But, sometimes it seems unclear whether what technical underpinnings lie under this sea change towards electric propulsion (if indeed it is so). And it has seemed obvious until now that the Tesla cars are the stars of the show in regards to electric transportation. These are by far and away the most exciting cars; they get far more hype and they get far more praise than any other electric car on the market. But why? What is really the state of the art and where does it reside? And most importantly, how long will it be until I own my own electric sportscar?</p>

<p>This is a story that can be illustrated with two simple graphics.</p>

<!--more-->


<h3>1. Maximum Range of Electric Car Models (in Km)</h3>

<div id='chart'>
  <svg style='height:500px'> </svg>
</div>


<script src='/blog/assets/javascripts/scatter.js' type='text/javascript'></script>


<p>This first chart tells the story of the company called Tesla Motors, the upstart who had a breakout success with the Tesla Roadster. Their initial success gave them a great deal of financing and clout which they invested to - again - hit a home run with the Model S. These are both premium cars, and their appeal lies in their advanced nature. This is haute technology - their customers know they are buying into the best thing out there, even if they have to pay a price to do so. They take the state-of-the-art in battery technology, lifted straight from the realms of laptop batteries - and make it work on a grand scale. As a result, the batteries have a much longer range than anything else. The new cars can recharge very quickly, too. Tesla are currently building a supercharger network that allows you to recharge in the same time it takes to refill. There's even an ostentatious (and delightful) 17 inch touchscreen where the dashboard should be.</p>

<p>The thing that is striking about this picture is how little any other company seems to have done to advance the state of the art in electric cars. Aside from Tesla, the ONLY advancement we see came in the form of the GM EV1. The sad story of that model was well covered by the documentary "Who Killed the Electric Car?" (In brief - The development was driven by the need to comply with Californian regulations to provide zero-emissions cars, and once that regulation was dropped, the cars were herded up and hidden away to protect the more profitable core business).</p>

<h3>2. Retail Price of Electric Car Models (in inflation-adjusted 2014 dollars)</h3>

<div id='chart2'>
  <svg style='height:500px'> </svg>
</div>


<script src='/blog/assets/javascripts/scatter2.js' type='text/javascript'></script>


<p>It is here that we find how the rest of the auto industry has chosen to advance things. On the price point. The cost has dropped dramatically for electric vehicles, and the technology advances mean we are getting to the point where the lease pricing model, previously necessary to sell cars with very expensive batteries, is no longer required.</p>

<p>However, auto makers have not changed the positioning of electric cars. They are designed and sold as cars for running around the city; they are not expected to do everything that petrol cars can do. Even since the 1900s, this same paradigm has persisted. At that time, automakers even put fake radiators onto the electric cars to disguise their power source. And still today, electric cars are advanced as a relatively low-cost, responsible option. The maximum range of the cars that are sold is not high enough to suit all journeys, and no visions of developing electric charging infrastructure has been communicated by any company other than Tesla (although it does seem that Nissan is also putting some effort into building a charging station network).</p>

<p>The second component to this strategy is the hybrid product range. These hybrids are targeted at a more premium market, and they conceive the electric drive as an add-on. The electric motor is an additional feature which makes the car more energy efficient on short trips and it also gives the car a certain amount of eco-cred. And, this is not entirely a bad thing. Working solely within the restriction of current infrastructure, this works quite well - although it necessarily means the cars are slightly over-complicated in engineering terms, it does give the all-important reassurance on range. If I'm going on a road trip, it would probably be one of these cars I would want to be in.</p>

<h3>The Showdown</h3>

<p>This boils down to a battle of two business models. One is more simple. It only relies on the capabilities of electric cars as they are today - it sees them as a (relatively) low cost, low guilt proposition that can replace traditional city run-around cars. In the high-end market, the electric motor and battery are added to a petrol engine as an additional feature.</p>

<p>The downside of this, in engineering terms, is that it adds much more complexity to the engineering of the cars. In the context of the auto industry, this doesn't seem so alarming. In terms of design, new car models tend to be designed holistically - all the features interrelate in complex ways. For example, the aerodynamics of the body may intersect with the rigidity of the chassis and the packaging (where to put the engine and everything else so there is enough room in the cabin and in the boot). The car industry has no problems in dealing with this (primarily mechanical) flavour of complexity. It is, in fact, the core competency of successful players. Competing in the use of Internal Combustion Engine (ICE) vehicles, it is indeed necessary to have this expertise to produce the most attractive product.</p>

<p>In contrast, the electric vehicle is mechanically <a href="http://siepr.stanford.edu/system/files/shared/pubs/papers/EmergenceofElectricVehicleIndustry_Appendix.pdf">much more simple</a>. There are fewer components overall. The motor is a highly efficient commodity device, and has a flat torque curve, obviating the need for a gearbox. The battery itself is a component with a lot of complexity, and may therefore turn out to be a differentiating factor in the electric car market. However, the interface between the energy store and the motor is now electrical rather than mechanical, therefore the task of integrating components remains much easier compared with ICE vehicles. There are still some important relationships between the components, for example, suspension must be designed based on the weight which it carries, and the battery capacity requirements are partially determined by the overall package size and aerodynamic characteristics. But, importantly, these considerations are much fewer in an electric car than in an ICE-powered car.</p>

<p>Therefore, if a newcomer designs a electric car from the ground up using best practices from the ICE industry in the aerodynamics, suspension etc, then the task of building a car from individual components them is made easier. So, it is sustainable for an electric company to continue to be competitive on traditional market differentiators (Acceleration, Top Speed, Handling Characteristics, Noise, Vibration, Hardness etc...) while keeping its main focus on overcoming the deficiencies of current battery technology and charging infrastructure. And, as always, a start-up must improve operational efficiency by realising economies of scale. This reasoning forms the basis of Tesla's strategy.</p>

<h3>The Lithium-Ion Battery</h3>

<p>Interestingly, the products of this strategy does not fall under the traditional definition of disruptive innovations. This innovation is primarily "sustaining", as cars like the Tesla models seek to compete across all established competitive dimensions for luxury cars.</p>

<p>The truly disruptive technology here is the lithium-ion battery. As the technology has advanced, it has been able to incrementally supplant batteries across various applications - first in laptops and camcorders, next in cameras and cordless power tools. It is still a relatively expensive option in all of these markets, but has come to dominate them due to its higher energy density. Given the improvement rate in energy density, averaging 10% per year, it seems a safe bet that lithium ion batteries have the potential to disrupt the ICE automotive market in the near future. It seems as though the challenges on recharging time have already been addressed reasonably well.</p>

<h3>Conclusion</h3>

<p>It is still a matter of considerable debate whether the battery on any electric car would fulfil a consumers expectations on range for a petrol-powered car. And there is still a significant up-front premium for electric cars which results from the cost of the electric battery. But, as demand for Tesla cars seems to indicate, it seems that these drawbacks are more than compensated for by the  performance and eco-friendly nature of a luxury electric car.</p>

<p>And, as as their share price hints at, there seem to be reasons to think that the problems may soon be solved. At least the first problem may be solved in the next couple of years - as fast charging stations proliferate, and we may expect the second to be also solved in the relative near-term. It seems feasible for electric cars to entirely replace petrol-powered vehicles sooner rather than later.</p>
</p>
			</div>
			<div class="categories">
			Category: 
			
				<a href="/categories/technology.html">technology</a>
			
			</div>
		  </div>
		  <hr>
      
		   <div class="postpreview">
			<div class="postcontent">
				<div class="date">September  1, 2013</div>
				<h2><a href="/blog//2013/09/01/Essentials-of-Vim">Using Vim: Just the Essentials</a></h2>
				<p><p>Vim is a text editor with a lot of history and a lot of advocates. It is also universally available on Unix-based systems. And, for this reason, some things become much easier when you know how to use it. It is more confusing initially than other editors - after not using it for a while and coming back to it I have found myself perplexed as how to actually edit the text! But, there are only a small number of things you need to remember to use it effectively.</p>

<!--more-->


<h3>Ensure vim can write to file</h3>

<p>On Unix boxes, you can run <code>sudo vim [filename]</code> to run the editor with elevated privileges. Depending on the privileges set on the file, this may or not be necessary.</p>

<p>Alternatively, if you open a file and discover you don't have permission to write it, you can save it with sudo using the following Vim command: <code>:w !sudo tee %</code>.</p>

<h3>Command and Append Modes</h3>

<p>The keys you press have different functions depending on which of the two modes you are in. At first, you will start off in command mode. In this mode, the keyboard buttons are used to send different commands to the editor. You are still able to navigate the text with the arrow keys or h,j,k,l (left, down, up, right).</p>

<p>You may change to the Append mode by entering one of the following commands:</p>

<ul>
<li><code>a</code> - append, start writing from the next character position</li>
<li><code>i</code> - insert, starts writing from the current character</li>
<li><code>o</code> - start writing from a new line</li>
</ul>


<p>In the append mode you may use the keyboard in the "normal" way, to enter text into the document. Then, to return to control mode, you press the Esc key.</p>

<h3>Essential Commands - Saving</h3>

<ul>
<li><code>:w</code> will save (write) the file</li>
<li><code>:wq</code> or <code>:x</code> will save and exit</li>
<li><code>:q!</code> will exit and discard changes</li>
<li><code>:w newfile</code> will save the text to newfile</li>
</ul>


<h3>Very Useful Commands - Navigation</h3>

<ul>
<li><code>*</code> or <code>#</code> will search for the next/previous instance of the currently selected word</li>
<li><code>/astring</code> will search for "astring" in the file</li>
<li><code>ctrl + o</code> restores the position before the search was made</li>
<li><code>w</code> and <code>b</code> move forward/backwards one word</li>
<li><code>^</code> and <code>$</code> move to the start/end of a line</li>
</ul>


<h3>Very Useful Commands - Editing</h3>

<ul>
<li><code>~</code> toggles the case of the selected character</li>
<li><code>J</code> joins the following line to the current line</li>
<li><code>dd</code> cuts ("deletes") the current line</li>
<li><code>y</code> copies ("yanks") the current line</li>
<li><code>p</code> and <code>P</code> paste before/after the cursor</li>
</ul>


<h3>More</h3>

<ul>
<li><code>.</code> repeats the previous command</li>
<li><code>:help</code> provides additional information - there is much more than is described here!</li>
<li><a href="http://www.viemu.com/a-why-vi-vim.html">Here</a> is some further information on the benefits of using Vim and more details on how you can make the most of it</li>
</ul>

</p>
			</div>
			<div class="categories">
			Category: 
			
				<a href="/categories/technology.html">technology</a>
			
			</div>
		  </div>
		  <hr>
      
		   <div class="postpreview">
			<div class="postcontent">
				<div class="date">August 26, 2013</div>
				<h2><a href="/blog//2013/08/26/Android-List-Pattern">Android: Editing Lists of Values</a></h2>
				<p><p>I have been working with lists in the Android app I'm working on, and I found that they have a bit of a learning curve. Its always the case in programming - there are some things, that seem like they should be easy, which can often be quite complicated. And, lists are one of those things in Android: not that intuitive; you have to learn to do things the "Android way". However, after coming to understand the tools that the Android framework gives us, we can quite quickly construct a flexible and robust solution.</p>

<!--more-->


<h3>Background - Basic UX</h3>

<p>In keeping with UI patterns on mobile platforms, we should try to keep the screens very simple. So, as a simple phone-centric solution, I created one <code>Activity</code> class which would perform all the activities associated with displaying and updating the multivalued attribute. The object containing the list can be passed in and out quite simply as an extra in the <code>Intent</code>, as this object implements the <code>Parcelable</code> interface.</p>

<h3>Activity Overview</h3>

<p>At the top level, the solution breaks down into two parts:<br/>
1. Loading a <code>ListView</code> with a customised item view containing <code>EditText</code>'s<br/>
2. Assign a custom <code>Adapter</code> class which will interface between the elements in the UI and the list we want to manage.</p>

<p>Now, let's break the problem down in more detail.</p>

<h3>Implementing a <code>ListView</code></h3>

<p>Implementing the <code>ListView</code> in itself is not so difficult. First we will define a top level layout for our <code>Activity</code> to use, which must contain the <code>ListView</code> that we will customize. This <code>ListView</code> object by itself only can specify how the items in the list are to be presented (eg the alignment of the list) and not the layout of the individual items in the list. As usual, we use <code>setContentView()</code> to load the class in our <code>Activity</code>. So in my layout resource file below, I take a standard list, and attach to it a header and a footer (defined in external layout files), which will ensure that a button to add additional entries to the list is always present, as well as save and cancel buttons:</p>

<pre><code>&lt;RelativeLayout  xmlns:android="http://schemas.android.com/apk/res/android"
                android:orientation="vertical"
                 android:layout_width="fill_parent"
                 android:layout_height="fill_parent"&gt;
    &lt;include android:id="@+id/header"
             layout="@layout/list_header_layout"
             android:layout_width="fill_parent"
             android:layout_height="wrap_content"
             android:layout_alignParentTop="true" /&gt;
    &lt;include android:id="@+id/footer"
             layout="@layout/list_footer_layout"
             android:layout_width="fill_parent"
             android:layout_height="wrap_content"
             android:layout_alignParentBottom="true" /&gt;
    &lt;ListView android:id="@+id/listinput"
              android:layout_width="match_parent"
              android:layout_height="wrap_content"
              android:layout_below="@id/header"
              android:layout_above="@id/footer"/&gt;
&lt;/RelativeLayout&gt;
</code></pre>

<h3>A Custom Adapter</h3>

<p>After loading the layout file, we must find the <code>ListView</code> object that is defined here so that we can attach a custom <code>Adapter</code> to it in our <code>Activity</code>. This <code>Adapter</code> will define the layout of the items in the list, and it will take care of initialising and updating those layouts. This class can initially seem a little opaque, though we can come to understand it by analysing the contents. There are some boilerplate methods we must add, but of primary importance is the following method that is used to load the layout of individual items in the list:</p>

<pre><code>public View getView(int position, View convertView, ViewGroup parent) {
    ViewHolder holder;

    if (convertView == null) {
        holder = new ViewHolder();
        convertView = mInflater.inflate(R.layout.listitem_multivalueinput, null);
        holder.attributeValue = (EditText) convertView.findViewById(R.id.attributeValue);
        holder.attributeDeleteButton=(Button)convertView.findViewById(R.id.deleteValueButton);  
        convertView.setTag(holder);
    } else {
        holder = (ViewHolder) convertView.getTag();
    }

    //Fill EditText with the value you have in data source
    holder.attributeValue.setText(myAttributes.get(position).toString());
    holder.attributeValue.setTag(position);
    holder.attributeDeleteButton.setTag(position);

    //we need to update adapter once we finish with editing
    holder.attributeValue.setOnFocusChangeListener(new View.OnFocusChangeListener() {
        public void onFocusChange(View v, boolean hasFocus) {
            if (!hasFocus){
                final int position = (Integer) v.getTag();
                final EditText Caption = (EditText) v;
                if (!myAttributes.get(position).equals(Caption.getText().toString())) {
                    myAttributes.add(position, Caption.getText().toString());
                }
            }
        }
    });
   holder.attributeDeleteButton.setOnClickListener(new View.OnClickListener() {
        @Override
        public void onClick(View v) {
            final int position = (Integer) v.getTag();
            myAttributes.remove(position);
            if (myAttributes.size() &lt; 1) {
                myAttributes.add("");
            }
            notifyDataSetChanged();
        }
    });
    return convertView;
}
</code></pre>

<p>There are quite a few things going on here, so lets step through it one by one. Firstly, if we are instantiating a view for the first time, then we need to inflate (load) the view from a layout resource file - which I have defined as <code>listitem_multivalueinput</code>. This file is quite simple, it is just a <code>LinearLayout</code> containing an <code>EditText</code> and a <code>Button</code>:</p>

<pre><code>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
                android:layout_width="fill_parent"
                android:layout_height="wrap_content"
                android:orientation="horizontal"&gt;
    &lt;EditText
            android:id="@+id/attributeValue"
            android:layout_width="0dp"
            android:layout_height="wrap_content"
            android:padding="10dp"
            android:textSize="16sp"
            android:layout_weight="7" /&gt;
    &lt;Button
            android:id="@+id/deleteValueButton"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="x"  &lt;!--don't do this--&gt;
            android:width="0dp"
            android:layout_weight="1"
            android:onClick="removeValue"/&gt;
&lt;/LinearLayout&gt;
</code></pre>

<p>The next step is to add the <code>EditText</code> and <code>Button</code> objects to a <code>ViewHolder</code> object. <code>ViewHolder</code> is a simple class which contains references to our layout objects. It is commonly used as we use it here, to tie the object references directly to the <code>ListItem</code> <code>View</code>. It is defined as a static class within the <code>Adapter</code>:</p>

<pre><code>static class ViewHolder {
    private EditText attributeValue;
    private Button attributeDeleteButton;
}
</code></pre>

<p>This reduces the number of calls that need to be made to the relatively expensive <code>findViewbyId()</code> method. Instead, when updating an existing <code>View</code> object, we can just grab the reference and go straight to populating the layout objects.</p>

<p>Finally, once we have added in the initial list value to the <code>EditText</code> and added the position directly onto the <code>EditText</code> and <code>Button</code> objects (as it may be useful to refer to it later!), we will set up the event listeners on the layout objects in the list item. Here we have two:<br/>
- <code>setFocusOnChangeListener()</code> on the <code>EditText</code>, which will write any altered value back into the underlying list whenever the <code>EditText</code> loses focus<br/>
- <code>setOnClickListener()</code> on the <code>Button</code>, which removes the value at that position and then calls <code>notifyDataSetChanged()</code> to force the <code>ListView</code> to refresh, in order to reflect the changes</p>

<h3>What's Left</h3>

<p>That covers almost everything - the only thing we have to do now is to decide whether to persist our changes or not. Since changes are being made to our list in realtime as we update the GUI, all we would need to do is save our object and pass it to the next activity - or to cancel changes we can just <code>Finish()</code> our <code>Activity</code> without needing to do anything else.</p>

<h3>Further Improvements</h3>

<p>If we wanted to extend this to make the view format more re-usable, this would be a good feature to include in an Android <code>Fragment</code> - it could match the recommended use of fragments for list and details views quite well. Then we could extend this phone-centric solution to make it more suited to tablets as well. But that will be a topic for another day.</p>

<h2>More Reading</h2>

<p><a href="http://www.vogella.com/articles/AndroidListView/article.html">A Comprehensive Guide to ListViews</a> - with lots of nice diagrams!</p>
</p>
			</div>
			<div class="categories">
			Category: 
			
				<a href="/categories/technology.html">technology</a>
			
			</div>
		  </div>
		  <hr>
      
  </div>
</div>
		</section>
	  </body>
	  <footer>
		<div class="copyright">
			Benjamin Vickers / 2013 / ©
		</div>
		<div class="projects">
			<!--Projects: <a href="/AmIConnected/">Am I Well Connected</a>-->
		</div>
	  </footer>
  </div>
</html>
